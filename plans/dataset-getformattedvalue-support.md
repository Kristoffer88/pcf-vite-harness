# Dataset getFormattedValue Support Plan

## Overview

This plan outlines the implementation of full `getFormattedValue` support for PCF dataset records in the pcf-vite-harness development environment. Currently, dataset records created by our datasetGenerator don't implement the `getFormattedValue` method that PCF components expect, leading to fallback behavior and potential inconsistencies.

## Problem Statement

1. **Missing Method**: Dataset records generated by `datasetGenerator.ts` don't include the `getFormattedValue` method that's part of the standard PCF dataset record interface
2. **Inconsistent Display**: Components must use workarounds (checking `_entityReference._name`) instead of the standard PCF API
3. **Limited Formatting**: No access to formatted values for dates, numbers, currencies, option sets, etc.
4. **Developer Experience**: PCF developers expect `getFormattedValue` to work as it does in production

## Current State

### What We Have
- `datasetGenerator.ts` creates records with:
  - `_entityReference._name` (primary name field)
  - Raw field values in `_record.fields`
  - Formatted values stored but not exposed via API

### What's Missing
- `getFormattedValue(columnName: string): string` method on each record
- `getNamedReference()` method for lookup fields
- Proper handling of all field types (dates, numbers, option sets, etc.)

## Proposed Solution

### 1. Record Interface Enhancement

Create a `DatasetRecord` class that implements the full PCF record interface:

```typescript
interface PCFDatasetRecord {
  getFormattedValue(columnName: string): string;
  getValue(columnName: string): any;
  getNamedReference(): ComponentFramework.EntityReference | null;
  getRecordId(): string;
  // ... other PCF methods
}
```

### 2. Implementation Strategy

#### Phase 1: Basic getFormattedValue Support
- Wrap generated records in a class that implements `getFormattedValue`
- Map OData formatted values to the method
- Handle primary name field specially

#### Phase 2: Field Type Handling
- Date/DateTime formatting based on user locale
- Number formatting (decimals, thousands separators)
- Currency formatting with symbols
- Option set labels
- Boolean Yes/No labels
- Lookup field names

#### Phase 3: Advanced Features
- Multi-select option sets
- Status reason formatting
- Duration fields
- Calculated/rollup field indicators

### 3. Technical Design

#### Record Wrapper Class
```typescript
class DatasetRecordWrapper {
  private _internalRecord: any;
  private _formattedValues: Map<string, string>;
  
  constructor(record: any, entityMetadata: EntityMetadataInfo) {
    this._internalRecord = record;
    this._formattedValues = this.extractFormattedValues(record);
  }
  
  getFormattedValue(columnName: string): string {
    // Implementation details...
  }
}
```

#### Integration Points
1. Update `createDatasetRecord` in datasetGenerator.ts
2. Modify dataset structure to use wrapped records
3. Ensure backward compatibility with existing code

### 4. Formatted Value Sources

1. **OData Formatted Values**: `@OData.Community.Display.V1.FormattedValue`
2. **Lookup Names**: From `_${field}_value@OData.Community.Display.V1.FormattedValue`
3. **Calculated Defaults**: For fields without OData formatting
4. **Metadata-based**: Use attribute metadata for proper formatting

### 5. Testing Strategy

#### Unit Tests
- Test each field type formatting
- Verify fallback behavior
- Test edge cases (null, empty, missing values)

#### Integration Tests
- Verify against real Dataverse data
- Compare with production PCF behavior
- Test with various entity types

#### Test Cases
1. Text fields with special characters
2. Date fields in different time zones
3. Currency with different symbols
4. Option sets with missing labels
5. Lookup fields with missing references
6. Multi-line text with formatting

### 6. Migration Path

1. **Backward Compatibility**: Keep `_entityReference._name` for existing code
2. **Deprecation Warnings**: Log when old patterns are used
3. **Documentation**: Update examples to use `getFormattedValue`
4. **Gradual Rollout**: Feature flag for new behavior

### 7. Performance Considerations

- Cache formatted values to avoid repeated calculations
- Lazy load formatting for large datasets
- Minimize metadata lookups
- Consider memory usage for large record sets

### 8. Error Handling

- Graceful fallback for missing formatted values
- Clear error messages for invalid column names
- Handle missing metadata scenarios
- Log warnings for development debugging

## Implementation Checklist

- [ ] Create DatasetRecordWrapper class
- [ ] Implement getFormattedValue with all field types
- [ ] Add getNamedReference for lookups
- [ ] Update datasetGenerator to use wrapper
- [ ] Create comprehensive unit tests
- [ ] Add integration tests with real data
- [ ] Update documentation
- [ ] Add TypeScript definitions
- [ ] Performance testing with large datasets
- [ ] Migration guide for existing users

## Success Criteria

1. PCF components can use `record.getFormattedValue()` without modifications
2. All field types return properly formatted values
3. Performance impact < 10ms for 1000 records
4. 100% backward compatibility
5. TypeScript intellisense support

## Future Enhancements

1. Locale-specific formatting
2. Custom format strings
3. Field-level security trimming
4. Calculated field formulas
5. Real-time formatting updates

## References

- [PCF Dataset API Documentation](https://docs.microsoft.com/en-us/power-apps/developer/component-framework/reference/dataset)
- [OData Formatting Annotations](https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part3-csdl.html)
- [Dataverse Web API Formatted Values](https://docs.microsoft.com/en-us/power-apps/developer/data-platform/webapi/query-data-web-api#formatted-values)